### 整理下上节的代码, 规范后便于以后扩展新功能

#### 创建 odoorpc/odoo.js 文件

```
import request from './request'

export class ODOO {
  constructor(payload) {
    const { baseURL, timeout = 50000 } = payload
    this._rpc = new request.ProxyJSON({ baseURL, timeout })
  }

  async json_call(url, payload) {
    const data = await this._rpc.call(url, payload)
    if (data.error) {
      throw data.error
    } else {
      return data.result
    }
  }

  async get_version_info() {
    const url = '/web/webclient/version_info'
    return await this.json_call(url, {})
  }
}

```

#### 修改 odoorpc/request.js 文件

```
import axios from 'axios'

class ProxyJSON {
  constructor(payload) {
    const { baseURL, timeout = 50000 } = payload
    this._baseURL = baseURL
    this._timeout = timeout
    this._service = this._get_service()
  }

  _get_service() {
    const service = axios.create({
      baseURL: this._baseURL,
      timeout: this._timeout
    })

    service.interceptors.request.use(
      config => {
        return config
      },
      error => {
        return Promise.reject(error)
      }
    )

    service.interceptors.response.use(
      response => {
        const res = response.data
        console.log(response)
        return res
      },
      error => {
        return Promise.reject(error)
      }
    )

    return service
  }

  async call(url, payload = {}) {
    const url2 = url[0] === '/' ? url : `/${url}`

    const data = {
      jsonrpc: '2.0',
      method: 'call',
      params: payload,
      id: Math.floor(Math.random() * 1000000000 + 1)
    }

    const response = await this._service({
      url: url2,
      method: 'post',
      data
    })

    return response
  }
}

export default { ProxyJSON }


```

#### 修改 odoorpc/test_rpc.js 文件

```
import { ODOO } from './odoo'

const baseURL = process.env.VUE_APP_BASE_API

export const test_rpc = () => {
  test_call_odoo()
}

const test_call_odoo = async () => {
  const api = new ODOO({ baseURL })

  const res = await api.get_version_info()
  console.log(res)
}

```

### 查询所有的数据库

#### 创建 odoorpc/web.js 文件

```
class _WEB {
  constructor(payload) {
    const { odoo } = payload
    this._odoo = odoo
  }
}

class Datebase extends _WEB {
  constructor(payload) {
    super(payload)
  }

  async list() {
    const url = '/web/database/list'
    return await this._odoo.json_call(url, {})
  }
}

export class WEB {
  constructor(payload) {
    this.datebase = new Datebase(payload)
  }
}

export default { WEB }

```

#### 修改 odoorpc/odoo.js 文件

```
// ...
// add script
import { WEB } from './web'

export class ODOO {
  constructor(payload) {
    // ...
    // add script
    this._web = new WEB({ odoo: this })
  }

  // add script
  get web() {
    return this._web
  }

  // ...

}

```

#### 修改 odoorpc/test_rpc.js 文件

```
import { ODOO } from './odoo'

const baseURL = process.env.VUE_APP_BASE_API

const api = new ODOO({ baseURL })

export const test_rpc = () => {
  // test_call_odoo()
  test_database_list()
}

const test_database_list = async () => {
  const res = await api.web.datebase.list()
  console.log(res)
}

const test_call_odoo = async () => {
  const res = await api.get_version_info()
  console.log(res)
}

```

### 创建和删除数据库

#### 修改 odoorpc/web.js 文件

```

class Datebase extends _WEB {
  constructor(payload) {
    super(payload)
  }

  async create(payload) {
    const { password, db_name, lang = 'zh_CN', user_password, login, country_code = 'CN', phone = ''} = payload

    const url = '/jsonrpc'

    const args = [ password, db_name, false, lang, user_password, login, country_code, phone ]
    const payload2 = { service: 'db', method: 'create_database', args }
    return await this._odoo.json_call(url, { ...payload2 })
  }

  async drop(payload) {
    const { password, db_name } = payload
    const url = '/jsonrpc'
    const args = [password, db_name]
    const payload2 = { service: 'db', method: 'drop', args }
    return await this._odoo.json_call(url, { ...payload2 })
  }

}

```

#### 修改 odoorpc/test_rpc.js 文件

```
export const test_rpc = () => {
  test_database_create()
  // test_database_drop()
}

const test_database_create = async () => {
  const payload = {
    password: 'admin',
    db_name: 'test_db',
    lang: 'zh_CN',
    user_password: '123456',
    login: 'admin',
    country_code: 'CN',
    phone: ''
  }
  const res = await api.web.datebase.create(payload)
  console.log(res)
}

const test_database_drop = async () => {
  const payload = { password: 'admin', db_name: 'test_db' }
  const res = await api.web.datebase.drop(payload)
  console.log(res)
}

```

#### 验证数据库创建成功

1. 浏览器打开 8069 端口
2. 访问数据库 test_db
3. 用户名: admin, 密码: 123456

#### 删除数据库

1. 修改 odoorpc/test_rpc.js
2. 调用 删除数据库的函数
3. 浏览器打开 8069 端口
4. 查看 test_db 是否已经删除

### 准备一个数据库, 以后备用

1. 运行创建数据库的代码, 准备一个数据库
2. 数据库名称 test_db
3. 用户名: admin, 密码: 123456
