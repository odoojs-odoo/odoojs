### context

#### 使用指南

1. 用户登陆后, 获取 api.env.context
2. 调用 Model 方法时, 默认取 api.env.context
3. 可以在 调用 Model 方法, 设置特定的 context

#### 修改 odoorpc/web.js 文件

```
class Session extends _WEB {
  constructor(payload) {
    super(payload)
    this._session_info = {}
  }

  get session_info() {
    return { ...this._session_info }
  }

  get context() {
    const context = this.user_context
    const allowed_company_ids = this.allowed_company_ids
    return { ...context, allowed_company_ids }
  }

  get current_company_id() {
    const user_companies = this.session_info.user_companies || {}
    const current_company = user_companies.current_company || [0, '']
    return current_company[0]
  }

  get allowed_company_ids() {
    const cids_str = this.get_cookie('cids')
    if (cids_str) {
      return cids_str.split(',').map(item => Number(item))
    } else {
      const user_companies = this.session_info.user_companies || {}
      const allowed_companies = user_companies.allowed_companies || []
      return allowed_companies.map(item => item[0])
    }
  }

  set allowed_company_ids(cids = []) {
    const cids_str = cids.join(',')
    this.set_cookie('cids', cids_str || String(this.current_company_id))
  }


  get_cookie(c_name) {
    var cookies = document.cookie ? document.cookie.split('; ') : []
    // console.log('document.cookie ', document.cookie)
    // console.log('cookies ', cookies)
    for (var i = 0, l = cookies.length; i < l; i++) {
      var parts = cookies[i].split('=')
      var name = parts.shift()
      var cookie = parts.join('=')

      if (c_name && c_name === name) {
        return cookie
      }
    }
    return ''
  }

  set_cookie(name, value, ttl) {
    // set cids,
    // odoo.set_cookie('cids', hash.cids || String(main_company_id));

    ttl = ttl || 24 * 60 * 60 * 365
    document.cookie = [
      name + '=' + value,
      'path=/',
      'max-age=' + ttl,
      'expires=' + new Date(new Date().getTime() + ttl * 1000).toGMTString()
    ].join(';')
  }


```

#### 修改 odoorpc/env.js 文件

```
export class Environment {
  constructor(payload) {
    const { odoo, context } = payload
    this._odoo = odoo
    this._context = context
  }

  get context() {
    if (this._context) {
      return this._context
    }
    const context = this.odoo.web.session.context
    return context
  }

  with_context(context) {
    const env = new this.constructor({ odoo: this._odoo, context })
    return env
  }

  copy(context) {
    return this.with_context(context)
  }

}
```

#### 修改 odoorpc/model.js 文件

```
export class MetaModel {
  static with_context(context, kwargs = {}) {
    const context2 = context ? context : this.env.context
    const context3 = { ...context2, ...kwargs }
    return this.with_env(this.env.copy(context3))
  }

  static with_env(env) {
    const OldModel = this
    class NewModel extends OldModel {
      constructor(...args) {
        super(...args)
      }
    }

    NewModel._env = env
    return NewModel
  }
}

```

#### 新增测试文件 odoorpc/test/addons/context.js 文件

```
import { LoginTestCase } from './base'

export default class ModelTestCase extends LoginTestCase {
  async test_with_context() {
    await this.login()
    const context2 = this.api.env.context
    const lang = 'en_US'
    //   const lang = 'zh_CN'
    const context = { ...context2, lang }
    const model = 'ir.module.module'
    const Model2 = this.api.env.model(model)
    const Model = Model2.with_context(context)
    const res = await Model.name_search()
    console.log(res)
  }

  async test_with_env() {
    await this.login()
    const api = this.api
    const context2 = api.env.context

    const lang = 'en_US'
    //   const lang = 'zh_CN'
    const context = { ...context2, lang }
    const model = 'ir.module.module'
    const Model2 = api.env.model(model)
    const env = api.env.copy(context)
    const Model = Model2.with_env(env)

    const res = await Model.name_search()
    console.log(res)
  }

  async test_env_copy() {
    await this.login()
    const api = this.api
    const context2 = api.env.context

    const lang = 'en_US'
    //   const lang = 'zh_CN'
    const context = { ...context2, lang }
    const model = 'ir.module.module'
    const env = api.env.copy(context)
    const Model = env.model(model)
    const res = await Model.name_search()
    console.log(res)
  }
}

```

#### 修改 odoorpc/test_rpc.js 文件

```
export const test_rpc = async () => {
  // await test.base.test_call_odoo()
  // await test_session()
  // await test_dataset()
  await test_context()
}

const test_context = async () => {
  await test.context.test_with_context()
  await test.context.test_with_env()
  await test.context.test_env_copy()
}
```
