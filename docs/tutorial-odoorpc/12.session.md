### session

#### 修改 odoorpc/web.js 文件 增加 Session 部分

```
class Session extends _WEB {
  constructor(payload) {
    super(payload)
    this._session_info = {}
  }

  async authenticate({ db, login, password }) {
    const url = '/web/session/authenticate'
    const payload = { db, login, password }
    const session_info = await this._odoo.json_call(url, payload)
    this._session_info = session_info
    return session_info
  }

  async get_session_info() {
    const url = '/web/session/get_session_info'
    const session_info = await this._odoo.json_call(url, {})
    this._session_info = session_info
    return session_info
  }

  async check() {
    const url = '/web/session/check'
    return await this._odoo.json_call(url, {})
  }

  async destroy() {
    try {
      const url = '/web/session/destroy'
      await this._odoo.json_call(url, {})
      this._session_info = {}
      return true
    } catch (e) {
      this._session_info = {}
      throw e
    }
  }

  async get_lang_list() {
    const url = '/web/session/get_lang_list'
    return await this._odoo.json_call(url, {})
  }

  async modules() {
    const url = '/web/session/modules'
    return await this._odoo.json_call(url, {})
  }

  async change_password({ fields }) {
    // fields 的格式
    // const fields = [
    //   { name: 'old_pwd', value: '123456' },
    //   { name: 'new_password', value: '123456' },
    //   { name: 'confirm_pwd', value: '123456' }
    // ]

    const url = '/web/session/change_password'
    return await this._odoo.json_call(url, { fields })
  }
}

export class WEB {
  constructor(payload) {
    this.datebase = new Datebase(payload)
    this.session = new Session(payload)
  }
}


```

#### 修改 odoorpc/test/addons/base.js 文件

1. 增加以下代码

```

export class LoginTestCase extends BaseTestCase {
  constructor({ baseURL, login_info }) {
    super({ baseURL })
    this.login_info = login_info
  }

  async login() {
    const { db, login, password } = this.login_info
    return await this.api.web.session.authenticate({ db, login, password })
  }
}
```

#### 新增文件 odoorpc/test/addons/session.js 文件

```
import { LoginTestCase } from './base'

export default class SessionTestCase extends LoginTestCase {
  async authenticate() {
    const { db, login, password } = this.login_info
    const res = await this.api.web.session.authenticate({ db, login, password })
    console.log(res)
    return res
  }
  async get_session_info() {
    await this.login()
    const res = await this.api.web.session.get_session_info()
    console.log(res)
    return res
  }

  async check() {
    await this.login()
    const res = await this.api.web.session.check()
    console.log(res)
    return res
  }

  async destroy() {
    await this.login()
    const res = await this.api.web.session.destroy()
    console.log(res)
    return res
  }
  async get_lang_list() {
    await this.login()
    const res = await this.api.web.session.get_lang_list()
    console.log(res)
    return res
  }

  async modules() {
    await this.login()
    const res = await this.api.web.session.modules()
    console.log(res)
    return res
  }

  async change_password() {
    await this.login()
    const fields = [
      { name: 'old_pwd', value: '123456' },
      { name: 'new_password', value: '123456' },
      { name: 'confirm_pwd', value: '123456' }
    ]

    const res = await this.api.web.session.change_password({ fields })
    console.log(res)
    return res
  }
}


```

#### 修改 odoorpc/test_rpc.js 文件

```
import Test from './test'

const baseURL = process.env.VUE_APP_BASE_API
const master_pwd = 'admin'
const login_info = { db: 'test_db', login: 'admin', password: '123456' }

const config = { baseURL, master_pwd, login_info }
const test = new Test(config)

export const test_rpc = async () => {
  await test.base.test_call_odoo()
  await test_session()
}
const test_session = async () => {
  await test.session.authenticate()
  await test.session.get_session_info()
  await test.session.check()
  await test.session.destroy()
  await test.session.get_lang_list()
  await test.session.modules()
  await test.session.change_password()
}

```

### 几个接口的使用场景

1. authenticate 接口, 返回 session_info
2. 后续其他接口会用到 session_info 中的东西, 因此暂存
3. check 接口, 检查服务端 session 是否超期
4. get_session_info 接口, 返回 session_info
5. 跳转新页面时, 应调用 check 接口, 判断服务端是否超期
6. 页面刷新时, 应调用 get_session_info, 获得 session_info

### 关于 cookie 和 seesion_id

1. 认证成功后, 在 respond 的 headers 中携带 session_id
2. session_id 自动存储在 cookie 中
3. 后续调用接口自动携带 cookie
4. 如果是非 web 方式, 如微信小程序或者测试脚本, 调用接口, 则前端没有 cookie
5. 非 web 方式下, 处理 session_id

### 非 web 方式下, 调用接口时的 seesion_id 设置

#### 修改 odoorpc/request.js 文件

```

class ProxyJSON {

  constructor(payload) {
      ...
  }

  _get_service() {
    const service = axios.create({
      baseURL: this._baseURL,
      timeout: this._timeout
    })

    const that = this

    service.interceptors.request.use(
      config => {
        if (that._sid) {
          config.headers['X-Openerp-Session-Id'] = that._sid
        }
        return config
      },
      error => {
        return Promise.reject(error)
      }
    )

    service.interceptors.response.use(
      response => {
        const url = response.config.url
        const url_auth = '/web/session/authenticate'
        const url_info = '/web/session/get_session_info'

        if (url === url_auth || url === url_info) {
          // if run test or run from wx miniprograme, not cookie,
          // so wo set sid to call odoo

          const headers = response.headers
          const cookie = headers['set-cookie']
          if (cookie) {
            const cookie2 = cookie[0]
            const session_id = cookie2.slice(11, 51)
            that._sid = session_id
          }
        }

        const res = response.data
        // console.log(response)
        return res
      },
      error => {
        return Promise.reject(error)
      }
    )

    return service
  }

  async call(url, payload = {}) {
      ...
  }

}


```
